THREE.Binder={bind:function(t,i){return function(e,n){n.__binds||(n.__binds=[]);var s=t;_.isArray(e)&&(s=e[0],e=e[1]);for(var r=/^([^.:]*(?:\.[^.:]+)*)?(?:\:(.*))?$/.exec(e),a=r[1].split(/\./g),o=a.pop(),l=r[2]||o,p=a.shift(),u={"this":n}[p]||i[p]||t[p]||s;u&&(e=a.shift());)u=u[e];if(u&&(u.on||u.addEventListener)){var h=function(i){n[l]&&n[l](i,t)};THREE.Binder._polyfill(u,["addEventListener","on"],function(t){u[t](o,h)});var d={target:u,name:o,callback:h};return n.__binds.push(d),h}throw"Cannot bind '"+e+"' in "+this.__name}},unbind:function(){return function(t){t.__binds&&(t.__binds.forEach(function(t){THREE.Binder._polyfill(t.target,["removeEventListener","off"],function(i){t.target[i](t.name,t.callback)})}.bind(this)),t.__binds=[])}},apply:function(t){THREE.EventDispatcher.prototype.apply(t),t.trigger=THREE.Binder._trigger,t.on=t.addEventListener,t.off=t.removeEventListener,t.dispatchEvent=t.trigger},_trigger:function(t){if(void 0!==this._listeners){var i=this._listeners[t.type];if(void 0!==i){i=i.slice();var e=i.length;t.target=this;for(var n=0;e>n;n++)i[n].call(this,t,this)}}},_polyfill:function(t,i,e){i.map(function(){return t.method}),i.length&&e(i[0])}},THREE.Api={apply:function(t){t.set=function(t){var i=this.options||{},e=_.reduce(t,function(t,e,n){return i[n]!==e&&(t[n]=e),t},{});this.options=_.extend(i,e),this.trigger({type:"change",options:t,changes:e})},t.get=function(){return this.options},t.api=function(t,i){return t=t||{},i&&_.each(t,function(t,e,n){_.isFunction(t)&&(n[e]=_.partialRight(t,i))}),t.set=this.set.bind(this),t.get=this.get.bind(this),t}}},THREE.Bootstrap=function(t){if(t&&_.isString(t)&&(t=[].slice.apply(arguments)),_.isArray(t)&&(t={plugins:t}),!(this instanceof THREE.Bootstrap))return new THREE.Bootstrap(t);var i={init:!0,element:document.body,plugins:["core"],aliases:{},plugindb:THREE.Bootstrap.Plugins||{},aliasdb:THREE.Bootstrap.Aliases||{}};this.__options=_.defaults(t||{},i),this.__inited=!1,this.__destroyed=!1,this.__installed=[],this.plugins={},this.element=this.__options.element,this.__options.init&&this.init()},THREE.Bootstrap.prototype={init:function(){return this.__inited?void 0:(this.__inited=!0,this.install(this.__options.plugins),this.trigger({type:"ready"}),this)},destroy:function(){return this.__inited&&!this.__destroyed?(this.__destroyed=!0,this.trigger({type:"destroy"}),this.uninstall(),this):void 0},resolve:function(t){function i(t,e,s){if(s>=256)throw"Plug-in alias recursion detected.";return _.each(t,function(t){var r=n[t];r?e=e.concat(i(r,[],s+1)):e.push(t)}),e}t=_.isArray(t)?t:[t];var e=this.__options,n=_.extend({},e.aliasdb,e.aliases);return t=_.filter(t,function(t){var i=t.split(":");return i[1]?(n[i[0]]=i[1],!1):!0}),_.each(n,function(t,i){n[i]=_.isArray(t)?t:[t]}),i(t,[],0)},install:function(t){t=_.isArray(t)?t:[t],t=this.resolve(t),_.each(t,this.__install,this)},uninstall:function(t){t&&(t=_.isArray(t)?t:[t],t=this.resolve(t)),_.eachRight(t||this.__installed,this.__uninstall,this)},__install:function(t){var i=this.__options.plugindb[t];if(!i)throw"[three.install] Cannot install. '"+t+"' is not registered.";if(this.plugins[t])return console.warn("[three.install] "+t+" is already installed.");var e=i,n=new e(this.__options[t]||{},t);this.plugins[t]=n,n.install(this),this.__installed.push(n),this.trigger({type:"install",plugin:n})},__uninstall:function(t){return(plugin=_.isString(t)?this.plugins[t]:t)?(t=plugin.__name,plugin.uninstall(this),this.__installed=_.without(this.__installed,plugin),delete this.plugins[t],void this.trigger({type:"uninstall",plugin:plugin})):console.warn("[three.uninstall] "+t+"' is not installed.")}},THREE.Binder.apply(THREE.Bootstrap.prototype),THREE.Bootstrap.Plugins={},THREE.Bootstrap.Aliases={},THREE.Bootstrap.Plugin=function(t){this.options=_.defaults(t||{},this.defaults)},THREE.Bootstrap.Plugin.prototype={listen:[],defaults:{},install:function(){},uninstall:function(){}},THREE.Binder.apply(THREE.Bootstrap.Plugin.prototype),THREE.Api.apply(THREE.Bootstrap.Plugin.prototype),THREE.Bootstrap.registerPlugin=function(t,i){var e=function(i){THREE.Bootstrap.Plugin.call(this,i),this.__name=t};e.prototype=_.extend(new THREE.Bootstrap.Plugin,i),THREE.Bootstrap.Plugins[t]=e},THREE.Bootstrap.unregisterPlugin=function(t){delete THREE.Bootstrap.Plugins[t]},THREE.Bootstrap.registerAlias=function(t,i){THREE.Bootstrap.Aliases[t]=i},THREE.Bootstrap.unregisterAlias=function(t){delete THREE.Bootstrap.Aliases[t]},THREE.Bootstrap.registerAlias("empty",["renderer","bind","size","fill","loop","time"]),THREE.Bootstrap.registerAlias("core",["empty","scene","camera","render"]),THREE.Bootstrap.registerPlugin("renderer",{defaults:{klass:THREE.WebGLRenderer,parameters:{depth:!0,stencil:!0,preserveDrawingBuffer:!0,antialias:!0}},install:function(t){var i=t.renderer=new this.options.klass(this.options.parameters);t.canvas=i.domElement,t.element.appendChild(i.domElement)},uninstall:function(t){t.element.removeChild(t.renderer.domElement),delete t.renderer,delete t.canvas}}),THREE.Bootstrap.registerPlugin("bind",{install:function(t){this.three=t,this.ready=!1;var i={three:t,window:window};t.bind=THREE.Binder.bind(t,i),t.unbind=THREE.Binder.unbind(t),t.bind("install:bind",this),t.bind("uninstall:unbind",this),t.bind("ready",this)},uninstall:function(t){t.unbind(this),delete t.bind,delete t.unbind},ready:function(){this.ready=!0},bind:function(t,i){var e=t.plugin,n=e.listen,s={type:s};n&&n.forEach(function(t){var n=i.bind(t,e);this.ready&&t.match(/^ready(:|$)/)&&n(s,i)})},unbind:function(t,i){i.unbind(t.plugin)}}),THREE.Bootstrap.registerPlugin("size",{defaults:{width:null,height:null,aspect:null,scale:1,capWidth:1/0,capHeight:1/0},listen:["window.resize","element.resize","this.change:resize","ready:resize"],install:function(t){t.Size=this.api({renderWidth:0,renderHeight:0,viewWidth:0,viewHeight:0})},uninstall:function(t){delete t.Size},resize:function(t,i){var e,n,s,r,a,o,l,p,u=this.options,h=i.element,d=i.renderer,c=0,g=0;e=s=void 0===u.width||null==u.width?h.offsetWidth||h.innerWidth||0:u.width,n=r=void 0===u.height||null==u.height?h.offsetHeight||h.innerHeight||0:u.height,l=e/n,u.aspect&&(u.aspect>l?(n=Math.round(e/u.aspect),g=Math.floor((r-n)/2)):(e=Math.round(n*u.aspect),c=Math.floor((s-e)/2)),l=e/n),a=Math.min(e*u.scale,u.capWidth),o=Math.min(n*u.scale,u.capHeight),raspect=a/o,raspect>l?a=Math.round(o*l):o=Math.round(a/l),d.setSize(a,o),p=d.domElement.style,p.width=e+"px",p.height=n+"px",p.marginLeft=c+"px",p.marginTop=g+"px",_.extend(i.Size,{renderWidth:a,renderHeight:o,viewWidth:e,viewHeight:n,aspect:l}),i.trigger({type:"resize",renderWidth:a,renderHeight:o,viewWidth:e,viewHeight:n,aspect:l})}}),THREE.Bootstrap.registerPlugin("fill",{install:function(t){function i(t){var i=t.style.height;return"auto"==i||""==i}function e(t){return t.style.height="100%",t.style.margin=0,t.style.padding=0,t}t.element==document.body&&(this.applied=[t.element,document.documentElement].filter(i).map(e)),t.canvas&&(t.canvas.style.display="block")},uninstall:function(t){function i(t){return t.style.height="",t.style.margin="",t.style.padding="",t}this.applied&&this.applied.map(i),t.canvas&&(t.canvas.style.display="")}}),THREE.Bootstrap.registerPlugin("loop",{defaults:{start:!0},listen:["ready"],install:function(t){this.running=!1,t.Loop=this.api({start:this.start.bind(this),stop:this.stop.bind(this),running:!1},t)},uninstall:function(t){this.stop(t)},ready:function(t,i){this.options.start&&this.start(i)},start:function(t){if(!this.running){t.Loop.running=this.running=!0;var i=function(){this.running&&requestAnimationFrame(i),["pre","update","render","post"].map(function(i){t.trigger({type:i})}.bind(this))}.bind(this);requestAnimationFrame(i),t.trigger({type:"start"})}},stop:function(t){this.running&&(t.Loop.running=this.running=!1,t.trigger({type:"stop"}))}}),THREE.Bootstrap.registerPlugin("time",{listen:["pre:tick"],install:function(t){t.Time=this.api({now:0,delta:1/60,average:0,fps:0}),this.last=0},tick:function(t,i){var e=i.Time,n=e.now=+new Date/1e3,s=this.last;if(s){var r=e.delta=n-s,a=e.average||r;e.average=a+.1*(r-a),e.fps=1/a}this.last=n},uninstall:function(t){delete t.Time}}),THREE.Bootstrap.registerPlugin("scene",{install:function(t){t.scene=new THREE.Scene},uninstall:function(t){delete t.scene}}),THREE.Bootstrap.registerPlugin("camera",{defaults:{near:.1,far:1e4,type:"perspective",fov:60,aspect:null,left:-1,right:1,bottom:-1,top:1,klass:null,parameters:null},listen:["resize","this.change"],install:function(t){t.Camera=this.api(),t.camera=null,this.aspect=1,this.change({},t)},uninstall:function(t){delete t.Camera,delete t.camera},change:function(t,i){var e=this.options,n=i.camera;if(!i.camera||t.changes.type||t.changes.klass){var s=e.klass||{perspective:THREE.PerspectiveCamera,orthographic:THREE.OrthographicCamera}[e.type]||THREE.Camera;i.camera=e.parameters?new s(e.parameters):new s}_.each(e,function(t,n){i.camera.hasOwnProperty(n)&&(i.camera[n]=e[n])}.bind(this)),this.update(i),n===i.camera||i.trigger({type:"camera",camera:i.camera})},resize:function(t,i){this.aspect=t.viewWidth/Math.max(1,t.viewHeight),this.update(i)},update:function(t){t.camera.aspect=this.options.aspect||this.aspect,t.camera.updateProjectionMatrix()}}),THREE.Bootstrap.registerPlugin("render",{listen:["render"],render:function(t,i){i.scene&&i.camera&&i.renderer.render(i.scene,i.camera)}});